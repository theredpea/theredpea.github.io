<!--
 Your First PWA Codelab (https://g.co/codelabs/pwa)

 Copyright 2019 Google Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible"
          content="IE=edge" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <title>Weather PWA</title>
    <meta name="codelab"
          content="your-first-pwa-v3" />
    <link rel="stylesheet"
          type="text/css"
          href="/styles/inline.css" />
    <link rel="icon"
          href="/images/favicon.ico"
          type="image/x-icon" />

    <!-- CODELAB: Add link rel manifest -->
    <link rel="manifest"
          href="/manifest.json" />
    <!-- CODELAB: Add iOS meta tags and icons -->

    <meta name="apple-mobile-web-app-capable"
          content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style"
          content="black" />
    <meta name="apple-mobile-web-app-title"
          content="Weather PWA" />
    <link rel="apple-touch-icon"
          href="/images/icons/icon-152x152.png" />

    <!-- CODELAB: Add description here -->
    <meta name="description"
          content="A sample weather app" />

    <!-- CODELAB: Add meta theme-color -->
    <meta name="theme-color"
          content="#2F3BA2" />
    <style type="text/css">
        #canvas {
            width: 150px;
            /*         height: 100px; */
            height: 300px;
            position: absolute;
            top: 150px;
            left: 45%;
            text-align: center;
            background: aliceblue;
            /*light-blue; */
            z-index: 3000;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript">
        // )

        // console.log (average);
        // only log averages (?)
        // redraw
        //console.log(averages);
        var margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
            .select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        // Courtesy www/0AV.com, LGPL license or as set by forked host, Travis Holliday, https://codepen.io/travisholliday/pen/gyaJk
        // function startr() {
        console.log("starting...");
        navigator.getUserMedia =
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia;
        if (navigator.getUserMedia) {
            navigator.getUserMedia(
                {
                    audio: true
                },
                function (stream) {
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    // javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                    analyser.smoothingTimeConstant = 0.8;
                    analyser.fftSize = 1024;

                    microphone.connect(analyser);
                    analyser.connect(audioContext.destination);
                    // javascriptNode.connect(audioContext.destination);

                    canvasContext = $("#canvas")[0].getContext("2d");

                    var averages = [];

                    // javascriptNode.onaudioprocess = function() {
                    var requestAnimationFrameFunc = function () {
                        var array = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(array);
                        var values = 0;

                        var length = array.length;
                        for (var i = 0; i < length; i++) {
                            values += array[i];
                        }

                        var average = values / length;

                        //          console.log(Math.round(average - 40));

                        canvasContext.clearRect(0, 0, 150, 300);
                        canvasContext.fillStyle = "#BadA55";
                        canvasContext.fillRect(0, 300 - average, 150, 300);
                        canvasContext.fillStyle = "#262626";
                        canvasContext.font = "48px sans-serif"; //impact";
                        // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/fillText
                        canvasContext.fillText(Math.round(average - 40), -2, 300);
                        averages.push({
                            performanceNow: performance.now(),
                            average
                        });

                        //Read the data
                        //       d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/3_TwoNumOrdered_comma.csv",

                        //         // When reading the csv, I must format variables:
                        //         function(d){
                        //           return { date : d3.timeParse("%Y-%m-%d")(d.date), value : d.value }
                        //         },

                        // Now I can use this dataset:
                        (function (data) {
                            // Add X axis --> it is a date format
                            var x = d3
                                .scaleTime()
                                .domain(
                                    d3.extent(data, function (d) {
                                        return d.date;
                                    })
                                )
                                .range([0, width]);
                            xAxis = svg
                                .append("g")
                                .attr("transform", "translate(0," + height + ")")
                                .call(d3.axisBottom(x));

                            // Add Y axis
                            var y = d3
                                .scaleLinear()
                                .domain([
                                    0,
                                    d3.max(data, function (d) {
                                        return +d.value;
                                    })
                                ])
                                .range([height, 0]);
                            yAxis = svg.append("g").call(d3.axisLeft(y));

                            // Add a clipPath: everything out of this area won't be drawn.
                            var clip = svg
                                .append("defs")
                                .append("svg:clipPath")
                                .attr("id", "clip")
                                .append("svg:rect")
                                .attr("width", width)
                                .attr("height", height)
                                .attr("x", 0)
                                .attr("y", 0);

                            // Add brushing
                            var brush = d3
                                .brushX() // Add the brush feature using the d3.brush function
                                .extent([[0, 0], [width, height]]) // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
                                .on("end", updateChart); // Each time the brush selection changes, trigger the 'updateChart' function

                            // Create the line variable: where both the line and the brush take place
                            var line = svg.append("g").attr("clip-path", "url(#clip)");

                            // Add the line
                            line
                                .append("path")
                                .datum(data)
                                .attr("class", "line") // I add the class line to be able to modify this line later on.
                                .attr("fill", "none")
                                .attr("stroke", "steelblue")
                                .attr("stroke-width", 1.5)
                                .attr(
                                    "d",
                                    d3
                                        .line()
                                        .x(function (d) {
                                            return x(d.date);
                                        })
                                        .y(function (d) {
                                            return y(d.value);
                                        })
                                );

                            // Add the brushing
                            line
                                .append("g")
                                .attr("class", "brush")
                                .call(brush);

                            // A function that set idleTimeOut to null
                            var idleTimeout;
                            function idled() {
                                idleTimeout = null;
                            }

                            // A function that update the chart for given boundaries
                            function updateChart() {
                                // What are the selected boundaries?
                                extent = d3.event.selection;

                                // If no selection, back to initial coordinate. Otherwise, update X axis domain
                                if (!extent) {
                                    if (!idleTimeout)
                                        return (idleTimeout = setTimeout(idled, 350)); // This allows to wait a little bit
                                    x.domain([4, 8]);
                                } else {
                                    x.domain([x.invert(extent[0]), x.invert(extent[1])]);
                                    line.select(".brush").call(brush.move, null); // This remove the grey brush area as soon as the selection has been done
                                }

                                // Update axis and line position
                                xAxis
                                    .transition()
                                    .duration(1000)
                                    .call(d3.axisBottom(x));
                                line
                                    .select(".line")
                                    .transition()
                                    .duration(1000)
                                    .attr(
                                        "d",
                                        d3
                                            .line()
                                            .x(function (d) {
                                                return x(d.date);
                                            })
                                            .y(function (d) {
                                                return y(d.value);
                                            })
                                    );
                            }

                            // If user double click, reinitialize the chart
                            svg.on("dblclick", function () {
                                x.domain(
                                    d3.extent(data, function (d) {
                                        return d.date;
                                    })
                                );
                                xAxis.transition().call(d3.axisBottom(x));
                                line
                                    .select(".line")
                                    .transition()
                                    .attr(
                                        "d",
                                        d3
                                            .line()
                                            .x(function (d) {
                                                return x(d.date);
                                            })
                                            .y(function (d) {
                                                return y(d.value);
                                            })
                                    );
                            });
                        })(averages);
                        requestAnimationFrame(requestAnimationFrameFunc);
                    }; // end fn stream
                    requestAnimationFrame(requestAnimationFrameFunc);
                },
                function (err) {
                    console.log("The following error occured: " + err.name);
                }
            );
        } else {
            console.log("getUserMedia not supported");
        }
      // }
    </script>
</head>

<body>
    <h3>VU meter from mic input (getUserMedia API)</h3>
    <!--     <button
      onclick="startr();"
      title="click start needed as security in browser increased and voice mic can only be started from a gesture on page"
    >
      Start
    </button> 
<br />
    CLICK START
    <div align="left">See JS for attribution</div>

-->
    <canvas id="canvas"
            width="150"
            height="300px;"></canvas>
    <svg id="my_dataviz"></svg>
    <button id="install">

    </button>
    <script src="/scripts/app.js"></script>
    <!-- CODELAB: Add the install script here -->
    <script src="/scripts/install.js"></script>
    <script>
        // CODELAB: Register service worker.
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/service-worker.js").then(reg => {
                    console.log("Service worker registered.", reg);
                });
            });
        }
    </script>
</body>

</html>